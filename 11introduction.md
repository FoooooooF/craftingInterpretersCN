# 介绍

我很高兴我们能一起前进。 这是一本关于实现编程语言解释器的书。 这也是一本有关如何设计值得实施的语言的书。 这是我刚开始学习语言时希望拥有的书，也是我近十年来一直在脑海里写的书。童话故事远非真实：不是因为它们告诉我们龙的存在，而是因为他们告诉我们龙可以被殴打。

尼尔盖曼，卡洛琳

我很高兴我们能一起继续这一旅程。这是一本关于实现编程语言解释器的书。这也是一本有关如何设计值得实施的语言的书。这是我刚开始学习语言时希望拥有的书，并且这是我近十年来一直在脑海里写的书。

对于我的朋友和家人，对不起，我这么缺席！

在这些页面中，我们将逐步介绍两个完整的口译员，以提供全功能的语言。我假设这是您首次尝试语言，所以我将介绍构建完整，可用，快速的语言实现所需的每个概念和代码行。

为了在本书中塞满两个完整的实现而又不变成门挡，本文在理论上要比其他方面要轻。在构建系统的每个部分时，我将介绍其背后的历史和概念。我会尽力让您熟悉这行话，以便您在充满PL（编程语言）研究人员的鸡尾酒会中找到自己，这很 适合。

奇怪的是，我多次发现自己的情况。您不会相信其中一些可以喝多少。

但是我们主要是花我们的脑力来使语言启动并运行。这并不是说理论并不重要。在使用语言时，能够准确而正式地对语法和语义进行推理是一项至关重要的技能。但是，就我个人而言，我通过做中学到最好的东西。我很难遍历充满抽象概念的段落并真正吸收它们。但是，如果我已经编码，运行并调试了，那么我就 明白了。

静态类型系统尤其需要严格的形式推理。在类型系统上进行黑客攻击具有与证明数学定理相同的感觉。

事实证明这不是巧合。上世纪上半叶，Haskell Curry和William Alvin Howard证明了它们是同一枚硬币的两个方面： Curry-Howard同构。

那是我的目标。我希望您坚定地了解一种真实语言的生活和呼吸方式。我的希望是，当您以后阅读其他更多理论书籍时，其中的概念将牢牢地牢牢记住，并遵守这一切实的基础。

## 为什么要学习这个东西？
每本编译器书籍的每篇介绍似乎都包含此部分。我不知道引起这种存在性怀疑的编程语言是什么。我不认为鸟类学书籍为证明它们的存在而担心。他们假设读者喜欢鸟类并开始教学。

但是编程语言有些不同。我猜想，我们所有人创造出广泛成功的通用编程语言的可能性很小。即使不安装弹出式露营车，世界上通用语言的设计人员也可以安装在大众汽车上。如果加入该精英团体是学习语言的唯一原因，那么就很难证明其合理性。幸运的是，事实并非如此。

### 到处都是小语言
对于每种成功的通用语言，都有成千上万的成功利基语言。我们曾经称它们为“小语言”，但如今行话经济中的通货膨胀导致人们将其命名为“特定领域的语言”。这些是为特定任务量身定制的pidgins。考虑应用程序脚本语言，模板引擎，标记格式和配置文件。

少量语言的随机选择。

您可能会遇到的一些小语​​言的随机选择。

几乎每个大型软件项目都需要少数几个。如果可以，最好重用现有的而不是自己动手。一旦考虑了文档，调试器，编辑器支持，语法突出显示以及所有其他陷阱，那么自己动手就变得很困难。

但是，当没有现有的库可以满足您的需求时，您仍然有很大的机会发现自己需要解析器或其他东西。即使重用了一些现有的实现，您也不可避免地需要调试和维护它，并四处钻研。

### 语言是很好的锻炼
长跑运动员有时会用重物绑在脚踝上或在空气稀薄的高海拔地区训练。当他们以后减轻自己的负担时，轻便的肢体和富氧的空气带来了新的相对舒适度，使他们可以走得更远，更快。

实施语言是对编程技能的真正考验。该代码很复杂并且对性能至关重要。您必须掌握递归，动态数组，树，图和哈希表。你可能至少使用哈希表在你的一天到一天的程序，但如何好，你真的了解它们吗？好吧，在我们从头开始制作自己的作品后，我保证您会的。

尽管我打算向您展示一位口译员并不像您想象的那样令人生畏，但实施一口井仍然是一个挑战。兴高采烈，您将成为一名更强大的程序员，并且在日常工作中更加聪明地使用数据结构和算法。

### 另一个原因
我很难承认这最后一个原因，因为它离我的心很近。自从我小时候开始学习编程以来，我就感到语言有些不可思议。当我第一次使用BASIC程序时，一次只能获得一个键，我无法想象BASIC本身是如何制成的。

后来，当我的大学朋友谈论他们的编译器课程时，在他们的脸上充满敬畏和恐怖的表情，足以使我相信语言黑客是另一种人类-某些巫师被授予特权使用奥术。

这是一个迷人的图像，但具有较暗的一面。我 感觉自己不像个巫师，所以我以为自己缺乏加入阴谋集团所需的先天品质。尽管自从我在学校笔记本上拼写关键词以来，我一直对语言着迷，但我花了数十年的时间鼓起勇气尝试真正地学习它们。那种“神奇”的品质，那种排他的感觉，使我无法接受。

而且它的从业人员会毫不犹豫地发挥作用。关于编程语言的两个开创性文章的封面上有一条龙和一个向导。

当我终于开始凑齐自己的小口译员时，我很快了解到，当然，这根本没有任何魔术。这只是代码，而掌握语言的人就是人。

这里是你不是经常遇到的语言之外的一些技巧，有些部分是有点困难。但没有比您克服的其他障碍更困难的事情了。我的希望是，如果您对语言感到恐惧，并且这本书可以帮助您克服这种恐惧，也许我会让您比以前勇敢一点。

而且，谁知道，也许您会成为下一个很棒的语言。必须有人。

## 这本书的组织方式
这本书分为三个部分。您正在阅读第一个。这是两章，以使您适应新知识，教给您一些黑客使用的语言，并向您介绍我们将要实现的语言Lox。

其他两个部分分别构建一个完整的Lox解释器。在这些部分中，每章的结构都相同。本章采用单一语言功能，教您其背后的概念，并逐步介绍实现方法。

我花了很多时间进行反复试验，但是我设法将两个解释器分解为章节大小的块，这些块在前几章的基础上构建，但不需要后续的几章。从第一章开始，您将具有一个可以运行和使用的工作程序。在每一章中，它的功能越来越丰富，直到您最终拥有一门完整的语言为止。

除了丰富，闪烁的英语散文外，各章还包含其他一些令人愉悦的方面：

### 编码
我们对此各具特色的翻译，所以这本书包含真正的代码。其中包括所需的每一行代码，并且每个代码段都告诉您在不断增长的实现中将其插入到什么位置。

许多其他语言书籍和语言实现都使用诸如Lex 和Yacc之类的工具，即所谓的编译器-编译器，这些工具会自动从更高级别的描述中生成实现的某些源文件。这类工具各有利弊，双方都有很强的见解（有些人可能说宗教信仰）。

Yacc是一个接受语法文件并为编译器生成源文件的工具，因此它有点像输出编译器的“编译器”，这就是我们所说的“编译器-编译器”。

Yacc不是同类产品中的第一个，这就是为什么它被命名为“ Yacc”的原因-另一个编译器-编译器。后来的类似工具是Bison，在Yacc的发音中被称为“双关语”，例如“ yak”。



如果您发现所有这些小小的自我参考和双关语都充满乐趣，那么您会很适合这里。如果不是，那么，也许是语言书呆子的幽默感是一种后天的品味。

我们将在这里放弃使用它们。我要确保没有黑暗的角落可以隐藏魔术和混乱，因此我们将手工编写所有内容。如您所见，它并不像听起来那么糟糕，它意味着您确实会理解每一行代码以及两个解释器的工作方式。

一本书与“现实世界”有不同的限制，因此这里的编码风格可能并不总是反映编写可维护的生产软件的最佳方法。如果我对省略private或声明一个全局变量似乎有点不屑一顾，请理解我这样做的目的是使代码更容易被您看到。这里的页面没有您的IDE宽，每个字符都很重要。

另外，该代码没有太多注释。那是因为每一行都被几段诚实到上帝的散文围绕着。当您编写一本书以伴随您的程序时，也欢迎您省略评论。否则，您可能应该使用//比我更多的东西。

尽管本书包含每一行代码并讲解了每种含义，但它并未描述编译和运行解释器所需的机制。我假设您可以在自己选择的IDE中将一个生成文件或一个项目拍打在一起，以使代码运行。这些指示很快就会过时，我希望这本书能像XO白兰地一样变老，而不是后院。

### 片段
由于本书实际上包含了实现所需的每一行代码，因此代码片段非常精确。另外，由于即使缺少主要功能，我也会尝试将程序保持在可运行状态，因此有时会添加临时代码，这些代码将在以后的代码段中替换。

带有所有花哨的代码片段看起来像这样：
```
    default:
```
lox / Scanner.java
中的scanToken（）
替换1行
```
    if (isDigit(c)) {
        number();
    } else {
        Lox.error(line, "Unexpected character.");
    }
```
```
break;
```
lox / Scanner.java，在scanToken（）中，替换1行
在中心，您要添加新代码。它可能在上方或下方有一些淡出的线，以显示其在现有周围代码中的位置。也有一个简短的内容告诉您片段位于哪个文件中以及在何处放置。如果该Blurb表示“替换_行”，则需要删除并替换为新代码段的褪色行之间已有一些现有代码。

### 阿西德斯
旁白包含传记素描，历史背景，对相关主题的引用以及其他要探索的领域的建议。您无需了解它们就可以理解本书的后续部分，因此可以根据需要跳过它们。我不会评判你，但我可能会有些难过。

好吧，至少有一些助手这样做。他们大多数只是愚蠢的笑话和业余绘画。

### 挑战性
每章以一些练习结尾。与教科书中的习题往往会复习您已经涵盖的材料不同，这些习题集可以帮助您学习更多的知识，而不是本章中的内容。他们迫使您走出引导路线，自行探索。他们将使您研究其他语言，弄清楚如何实现功能，或者使您脱离舒适地带。

克服挑战，您将获得更广泛的理解，甚至可能遇到一些挫折。如果您想留在旅游巴士的舒适范围内，或者跳过它们。这是你的书。

提示：挑战通常会要求您对正在构建的口译员进行更改。您需要在代码副本中实现这些代码。在后面的章节中，假定您的口译员处于原始状态（“未受挑战”？）。

### 设计说明
大多数“编程语言”书籍都是严格的编程语言 实现书籍。他们很少讨论如何设计正在实施的语言。实现非常有趣，因为它是如此精确地定义。我们程序员似乎对黑白，一和零的事物具有亲和力。

我知道很多语言黑客的职业都基于此。您将一种语言规范滑入他们的门下，等待几个月，然后代码和基准测试结果就会出来。

就个人而言，我认为世界仅需要如此众多的FORTRAN 77实现。在某个时候，您会发现自己正在设计一种 新语言。一旦开始玩该游戏，方程式中较柔和，人性化的一面就变得至关重要。诸如哪些功能易于学习，如何在创新和熟悉之间取得平衡，哪种语法更易读以及对谁有帮助。

希望您的新语言不会将打孔卡宽度的假设硬编码到其语法中。

所有这些东西都会深刻影响您的新语言的成功。我希望您的语言能够成功，因此在某些章节中，我以“设计说明”结尾，这是关于编程语言的人文方面的一些小论文。我不是这方面的专家-我不知道是否有人真的-因此请带些盐吃。那应该使他们更美味地思考，这是我的主要目标。

## 第一口译员
我们将用Java编写我们的第一个解释器jlox。重点是概念。我们将编写最简单，最干净的代码，以正确实现该语言的语义。这将使我们熟悉基本技术，并磨练对语言的确切理解。

Java是一种很棒的语言。这个级别足够高，我们不会被繁琐的实现细节所淹没，但是它仍然很明确。与脚本语言不同，隐藏在幕后的机器通常不太复杂，并且您拥有静态类型以查看要使用的数据结构。

我还特别选择了Java，因为它是一种面向对象的语言。这种范式在90年代席卷了整个编程世界，如今已成为数百万程序员的主流思维方式。很有可能您已经习惯于将代码组织到类和方法中，所以我们将把您放在这个舒适的地方。

虽然学术语言人士有时会鄙视面向对象的语言，但事实是，它们甚至被广泛用于语言工作。与大多数JavaScript虚拟机一样，GCC和LLVM用C ++编写。面向对象的语言是无处不在的和工具和编译器的语言往往是写在了同一种语言。

编译器以一种语言读取文件。翻译它们，并以另一种语言输出文件。您可以使用任何一种语言（包括与该语言相同的语言）来实现编译器，该过程称为“自托管”。

您还不能使用其自身来编译您的编译器，但是如果您使用另一种语言编写了另一种针对您的语言的编译器，则可以使用该编译器一次来编译您的编译器。现在，您可以使用自己的编译器的已编译版本来编译其自身的将来版本，并且可以丢弃其他编译器中已编译的原始版本。这就是通过自己的引导程序将自己拉起来的形象的“引导”。

事实：这是美国牛仔的主要交通工具。

最后，Java非常流行。这意味着您很有可能已经知道了，因此学习入门的机会就更少了。如果您对Java不太熟悉，请不要害怕。我尝试坚持其中的一个很小的子集。我使用Java 7中的菱形运算符使事情更简洁，但就“高级”功能而言，仅此而已。如果您知道另一种面向对象的语言（例如C＃或C ++），则可以摸索。

在第二部分结束时，我们将有一个简单易读的实现。我们不会有一个快速的。它还利用了Java虚拟机自身的运行时设施。我们想学习Java本身是如何实现这些东西的。

## 第二口译员
因此，在下一部分中，我们将从头再来，但是这次是C语言。C语言是理解实现实际上是如何工作的完美语言，一直到内存中的字节和流经CPU的代码。

我们使用C的一个重要原因是，我可以向您展示C特别擅长的事情，但这确实意味着您需要对此非常满意。您不必是Dennis Ritchie的转世，但是您也不应该被指针所吓倒。

如果还没有，请找一本有关C的入门书并仔细阅读，然后在完成后回到这里。作为回报，您将远离本书，成为一个更强大的C程序员。鉴于用C编写了许多语言实现，这很有用：Lua，CPython和Ruby的MRI，仅举几例。

在我们的C解释器clox中，我们被迫自己实现Java免费提供给我们的所有东西。我们将编写自己的动态数组和哈希表。我们将决定对象如何在内存中表示，并构建一个垃圾回收器来回收它。

我说的名字像“ sea-locks”，但您可以说它是“ clocks”，甚至是“ clochs”，在这里您可以像希腊人那样说“ x”，如果它使您感到高兴。

我们的Java实现专注于正确性。既然我们对此感到沮丧，那么我们将转向快速。我们的C解释器将包含一个编译器，该编译器会将Lox转换为有效的字节码表示形式（不用担心，我很快就会明白这是什么意思），然后它就会执行。这与Lua，Python，Ruby，PHP和许多其他成功语言的实现所使用的技术相同。

您是否认为这只是一本口译书籍？这也是一本编译器书。两个一个的价格！

我们甚至会尝试进行基准测试和优化。到最后，我们将为我们的语言提供一个强大，准确，快速的解释器，能够跟上其他专业水平的实现。对于一本书和几千行代码来说还不错。

## 挑战性
在我拼凑而成的小系统中，至少有六种特定于领域的语言用于编写和出版本书。这些是什么？

获得一个“你好，世界！” 用Java编写并运行的程序。设置您需要的任何Makefiles或IDE项目。如果您有调试器，请先对其进行调试，然后逐步运行程序。

对C做同样的事情。要获得一些有关指针的练习，请定义一个 双向链接的堆分配字符串列表。编写函数以插入，查找和删除其中的项目。测试他们。

## 设计说明：名称中有什么？
编写本书时最困难的挑战之一就是为其实现的语言命名。在找到合适的候选人之前，我先浏览了几页候选人。就像您在开始建立自己的语言的第一天就会发现的那样，命名是非常困难的。一个好名字满足一些标准：

1. 尚未使用。如果您不小心踩到别人的名字，就会遇到各种麻烦，无论是法律上还是社会上的麻烦。

2. 这很容易发音。如果一切顺利，将会有成群的人在说和写您的语言名称。超过几个音节或几个字母的任何内容都会使他们无休止地烦恼。

3. 搜索足够独特。人们会用Google的语言名称来学习它，所以您想要一个很少见的单词，大多数结果都指向您的文档。虽然，随着当今AI搜索引擎的数量不断增加，这已不再是一个问题。不过，如果您将语言命名为“ for”，您将不会对用户有任何帮助。

4. 它在多种文化中没有负面含义。这很难捍卫，但是值得考虑。Nimrod的设计师最终将其语言重命名为“ Nim”，因为太多的人只记得Bugs Bunny使用“ Nimrod”（讽刺地是，实际上是侮辱）。

如果您的潜在名字是通过那根手套完成的，请保留它。不要挂在试图找到一个能代表您语言精髓的称谓上。如果世界上其他成功的语言的名称教给我们任何东西，那就是名称没什么大不了的。您需要的只是一个合理的唯一令牌。